import requests
from discord import ActionRow, Button, ButtonStyle

def exploit(keywords):
    link = "https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv"
    try:
        req = requests.get(link)
        data = req.text.split("\n")
        keywordsplit = keywords.split(" ")
        rows = []

        for row in data:
            splited = row.split(",")
            found = {}
            for word in keywordsplit:
                found[word] = False
                if (len(splited) == 17 and word.lower() in splited[2].lower()):
                    found[word] = True
            
            if (False not in found.values()):
                rows.append(splited)
        
        if (rows):
            ret = f"""**Query:** `{keywords}` ({len(rows)} exploit(s) found)

```
ID        TYPE          EXPLOIT
|--------|-------------|-------------------------------------------"""
            for row in rows:
                id = __formatout__("ID", row[0])
                type = __formatout__("TYPE", row[5])
                ret += f"""
{id}{type}{row[2]}"""
            
            ret += """```"""

            if (len(ret) > 2000 - 36 - len(keywords)):
                ret = "Query too vague. " + f"({len(rows)} exploit(s) found)"

            keywords = keywords.replace(" ", "+")
            components = ActionRow(
                Button(label="Results", style=ButtonStyle.blurple, emoji="ðŸ”—", url=f"https://www.exploit-db.com/search?q={keywords}"),
            )
            return ret, components
        else:
            ret = "No results returned."
    except:
        ret = "Could not perform query."

    return ret, None

def __formatout__(type, content):
    final = ""
    spaces = ""
    length = len(content)

    if (type == "ID"):
        spaces = " " * (10 - length)
    elif (type == "TYPE"):
        spaces = " " * (14 - length)

    final = content + spaces

    return final
